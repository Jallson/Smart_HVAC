## Smart HVAC System with Nicla Vision by Jallson Suryo![image01.jpg](https://www.dropbox.com/scl/fi/nzubfojovmocn0kxs0koz/image01.jpg?dl=0&rlkey=pwfpdeooh1l85j0vgo332hjie)Edge Impulse project link: https://studio.edgeimpulse.com/public/215243/latestDemo Video link (unlisted): https://youtu.be/QgQMWRZAlcY### Problem:The problem often found in HVAC systems is that energy got wasted because the system uses more energy than necessary or the system cannot quickly adjust to the changing needs in a dynamic environment. To tackle the problem, we need a system that manages its power intensity based on what is necessary for each zones in real-time for a given environment. The power intensity necessary for each zones can be derived from the following data: number of person, time duration spent inside, and/or the person’s activity.### Our Solution:Smart HVAC System that can optimize energy consumption by adjusting the power intensity in different zones inside an office or a residential space (zones with more people, more activity and longer time durations will need more cooling/heating and vice versa). The zone heat mapping will be generated using data obtained from Nicla Vision (with Edge Impulse's FOMO ML model embedded) that’s mounted like a surveillance camera inside the space.### Description:The project uses Edge Impulse’s FOMO to detect multiple objects and its coordinates using a compact micro-controller with on-board camera (Nicla Vision). The object detection ML model will use the top view of miniature figures with standing and sitting positions as objects. The data captured will be divided into training and test data. Then the Impulse with Image and Object Detection as learning blocks and grayscale color blocks will be created.The accuracy result for this training and test model is above 90% so there is confidence when counting the number of objects (person) and tracking its centroid coordinates.The ML model is then deployed to the Nicla Vision. The number of objects in each zone is displayed into the OLED display. The Nicla Vision also communicates to an Arduino Nano via I2C which we are using for the fan speed controller.This system will increase fan intensity on areas/zone that need more cooling/heating, which means more activity/people on a certain zone will increase fan intensity on that zone. The total HVAC power output can also be adjusted based on the total number of people in the space. The project is a proof of concept (PoC) using a 1:50 scale model with an office interior with several partitions and furniture and miniature figures. The space is divided into 4 zones, each zone has a small fan installed. The OLED display is used in this PoC to show the output of this simulation.![image02.jpg](https://www.dropbox.com/scl/fi/1n0zjpj5je0nheziy1lb0/image02.jpg?dl=0&rlkey=a07bonsytjthzxm8rydelm46h)![image03.jpg](https://www.dropbox.com/scl/fi/zoleq0zfin1tu5i73gjv8/image03.jpg?dl=0&rlkey=n1q8jj8roten8412zb76ad0lg)![image04.jpg](https://www.dropbox.com/scl/fi/w1eop2584pdihioj1371m/image04.jpg?dl=0&rlkey=54gd34zpj0mdk1c28y97rgrs0)![image05.jpg](https://www.dropbox.com/scl/fi/3a5wu1ozlcjdla1nmnz1o/image05.jpg?dl=0&rlkey=3fwjcbs4dm3qc1ka1kuairfg4)Arduino Nicla Vision, aluminium extrusion frame, and 3D printed miniature model (1:50)System Diagram , prototyping in breadboard, and Smart HVAC System with custom design PCB#### Hardware Component:- Arduino Nicla Vision- Arduino Nano- 2x TB6612 Motor drivers- 4x DC 5V mini fan 3cm- 0.96inch OLED display- Aluminium extrusion as a standee- 3D printed (case, office interior 1:50 miniature)- Powerbank & battery for Nicla Vision#### Software & Online Services:- Edge Impulse Studio- Arduino IDE- OpenMV IDE### Steps:#### 1. Prepare Data / PhotosIn this project we will use a smartphone camera to capture the images for data collection for ease of use. Take picture from above in different positions with backgrounds of varying angles lighting condition to ensure that the model can work under slightly different conditions (to prevent overfitting). FYI, lighting and object size are crucial aspect to ensure the performance of this model.Note: Keep the size of the objects similar in size in the pictures. Significant difference in object size will confuse the FOMO algorithm.#### 2. Data acquisition, and labellingOpen studio.edgeimpulse.com , login (or create an account first) then create a new project.Choose Images project option, then Classify Multiple Objects. In Dashboard > Project Info, choose Bounding Boxes for labelling method and Nicla Vision for target device. Then in Data acquisition, click on Upload Data tab, choose your photo files, auto split, then click Begin upload.Click on Labelling queue tab then start drag a box around an object and label it (person) and Save. Repeat.. until all images labelled. ![image06.png](https://www.dropbox.com/scl/fi/1y0s0gva9lzdl9k86vkh0/image06.png?dl=0&rlkey=gxepnk2cceo66sxxvhul42tmd)![image07.png](https://www.dropbox.com/scl/fi/i6883i57qx5brgp9irbk7/image07.png?dl=0&rlkey=0bmtapjmvh7nfwmnkdc15znad)Make sure that the ratio between Training and Test data is ideal, around 80/20.#### 3. Training and building model using FOMO Object DetectionOnce you have the dataset ready, go to Create Impulse and set 96 x 96 as image width - height (this help in keeping the ML model small in memory size). Then choose Fit shortest axis, and choose Image and Object Detection as learning blocks.Go to Image parameter section, select color depth as Grayscale then press Save parameters. Then click on Generate and navigate to Object Detection section, and leave training setting for Neural Network as it is — in our case is quite balanced pre-trained model, then we choose FOMO (MobileNet V2 0.35). Train the model by press the Start training.. and you can see the progress.If everything is OK, then we can test the model, go to Model Testing section and click Classify all. Our result is above 90%, then we can move on to the next step — deployment.![image08.png](https://www.dropbox.com/scl/fi/ig9g6h71z57tq87apee6p/image08.png?dl=0&rlkey=wluec9c0nahlx64lp9fiq4tmf)![image09.png](https://www.dropbox.com/scl/fi/frmyzf71nbombikwsyn85/image09.png?dl=0&rlkey=9424688ljo0mx9lvgmhb1z2aw)![image10.png](https://www.dropbox.com/scl/fi/r5zuhb5mnain1m0g910fz/image10.png?dl=0&rlkey=e4zkic990qnisaww9s7hz21e8)![image11.png](https://www.dropbox.com/scl/fi/rfokhg0h28k3vg5e7dqvr/image11.png?dl=0&rlkey=jic322yhom3t1ajyuzqd5hejf)#### 4. Deploy to OpenMV firmware and test it.![image12.png](https://www.dropbox.com/scl/fi/5cdi424rb19108apzmtor/image12.png?dl=0&rlkey=lk28qjy2xo6flwuvo481mr5zr)![image13.jpg](https://www.dropbox.com/scl/fi/x8cxcp2ss8k2xssdgizam/image13.jpg?dl=0&rlkey=5emqcrbzo051euh48ra2wnrb1)To use the OpenMV firmware, you will need the OpenMV IDE installed in your computer. Once you have the IDE ready, if you check the downloaded zip folder you will find a number of files. We will need the following files:*edge_impulse_firmware_arduino_nicla_vision.bin* and *ei_object_detection.py*. The next step is loading the downloaded firmware containing the ML model to the Nicla Vision board. So go back to OpenMV and go to Tools -> Run Bootloader (Load Firmware), select the *.bin* file in the unzipped folder, and click Run.Next, we will run the python code. Go to File -> Open File and select the .py python file from the unzipped folder. Once the file is opened, connect the Nicla Vision board, select the serial/com port and click the green “play” button. The program should be running now and you can see the FOMO object detection will run live on a small window.![image14.png](https://www.dropbox.com/scl/fi/nky9dgjqvabi3himt3wlt/image14.png?dl=0&rlkey=i34awz80t80g1fyjmpi8l1oae)#### 5. Deploy and Build an Arduino program![image15.png](https://www.dropbox.com/scl/fi/oenyd01uvhtfymmou55pf/image15.png?dl=0&rlkey=2g7vdmzu5rk4jeasmg8bcbyup)![image16.png](https://www.dropbox.com/scl/fi/v20jw9a35zqpywzq4gwdj/image16.png?dl=0&rlkey=ma1c4qtip9z1ggi1e4a89k4y5)You should have the Arduino IDE installed on your computer for the following step. Once the Edge Impulse Arduino Firmware is built, downloaded and unzipped, you should download the *nicla_vision_camera_smartHVAC_oled.ino* code which can be downloaded here (https://github.com/Jallson/Smart_HVAC/blob/main/nicla_vision_camera_smartHVAC_oled.ino) and place it inside the unzipped folder from Edge Impulse. Once the *.ino* code is inside Edge Impulse unzipped folder, move it to your Arduino folder on your computer. Now you can upload the *.ino* code to your Nicla Vision board via the Arduino IDE.The *.ino code* is a modified version of the Edge Impulse example code for object detection on Nicla Vision. The modification adds capability to display person count on each room to the OLED screen and act as the controller to the Arduino Nano I2C peripheral. The code distinguishes the four rooms using four quadrants and by knowing the X, Y coordinates of the object’s centroid we can locate the person. The Arduino Nano adjusts the fan motor using PWM based on the number of person present in the room.The code for the Arduino Nano peripheral *Nano_SmartHVAC_I2C_Peripheral.ino* can be downloaded here (https://github.com/Jallson/Smart_HVAC/blob/main/Nano_SmartHVAC_I2C_Peripheral.ino).Prototype test video: https://youtube.com/shorts/DnW0lFKFCdk?feature=share### ConclusionFinally, we have successfully implemented this object detection model into Arduino Nicla Vision and use the data captured from the camera to automatically control the HVAC system’s fans’ power intensity and then display the occupancy number and power meter for each zones. I believe this Proof of Concept project can be implemented in the real world HVAC system, so that the goal of optimizing room temperature and saving energy can be achieved for a better more sustainable future.Check again our complete demo video: https://youtu.be/QgQMWRZAlcY